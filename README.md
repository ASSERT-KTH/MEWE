# MEWE

MEWE is a toolset and methodology tailored to provide multivariant execution.


```bibtex
@article{arteaga2021multi,
  title={Multi-Variant Execution at the Edge},
  author={Arteaga, Javier Cabrera and Laperdrix, Pierre and Monperrus, Martin and Baudry, Benoit},
  journal={arXiv preprint arXiv:2108.08125},
  year={2021}
}
```

## Try it out

The following example generates a multivariant binary that can execute in your local machine. Make sure you have the LLVM toolchain in your system version 12.

```bash
######  SOURCE CODE TO BE INCLUDED IN THE MULTIVARIANT
f1="
#include<stdio.h>

    int dosomething() {
    // Variant 1 sleeps for 1 second
    sleep(1);
    return 0;
}
"

f2="
#include<stdio.h>

int dosomething() {
    // Variant 2 sleeps for 5 second
    sleep(5);
    return 0;
}
"

######  ENTRYPOINT

entrypoint="
#include <time.h>
#include <stdio.h>

int dosomething();

int discriminate(int size) {
   int r = rand();
   return r%size;
}

int main() {
   // Setting up the random generator
   srand(time(NULL)); 

   int r = dosomething();
   return 1;
}

"

echo "$f1" > f1.c
echo "$f2" > f2.c
echo "$entrypoint" > entrypoint.c

echo "Generating bitcodes"
clang f1.c -emit-llvm -c -o f1.bc
clang f2.c -emit-llvm -c -o f2.bc
clang entrypoint.c -emit-llvm -c -o entrypoint.bc


######  DOWNLOADING OUR LINKER
if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        wget -O build.zip https://github.com/Jacarte/MEWE/releases/download/binaries/build.linux.llvm12.x.x64.zip
elif [[ "$OSTYPE" == "darwin"* ]]; then
        wget -O build.zip https://github.com/Jacarte/MEWE/releases/download/binaries/build.macos.llvm12.zip
elif [[ "$OSTYPE" == "win32" ]]; then
        wget -O build.zip https://github.com/Jacarte/MEWE/releases/download/binaries/build.windows.llvm12.x.winx64.zip
else
        echo "NOT SUPPORTED OS $OSTYPE"
fi


unzip build.zip -d linker

linker/build/mewe-linker "f1.bc" "allinone.bc"  --complete-replace=false -merge-function-switch-cases --replace-all-calls-by-the-discriminator -mewe-merge-debug-level=1 -mewe-merge-skip-on-error  -mewe-merge-bitcodes="f2.bc"

# Link the random source for the dispatcher
llvm-link allinone.bc entrypoint.bc -o allinone.complete.bc


llc -filetype=obj allinone.complete.bc -o allinone.o
clang allinone.o -o allinone

time ./allinone

```

# Extended linker and multivariant generation

Our [linker](multivariant-mixer) takes a collection of LLVM libraries as input and outputs a big library containing semantically equivalent functions (yet statically different) for which we orchestrate their execution at runtime.

 
# MEWE multivariants

With our linker, you can start creating multivariant libraries. To do so, you need to be able of creating semantically equivalent functions out of the original library. A previous [work of us](https://github.com/KTH/slumps/tree/master/crow) uses a superoptimizer to create a handful number of variants out of a single LLVM bitcode. We provide an [example](examples/calling_crow) about how to use CROW to generate variants.

Notice that, this approach will work with any diversifier, as soon as it fits with our linker in terms of binary correctness. 

# Walkthrough

To create multivariant programs we follow the next steps:

1. Generate the library variants.
2. Call our linker to generate the multivariant library.
3. Glue the multivariant library with an entrypoint, e.g. an executable.

Look for examples [here](examples)

# Multivariant binaries at the Edge


With MEWE, we use an extended LLVM linker, CROW and the Fastly ABI to also provide WebAssembly multivariant binaries that can be successfully deployed to the Fastly's platform. 

![diagram](docs/diagram2.png)


We created a proof of concept of deploying multivariants at the Edge (see the [fastly](fastly) folder), specifically at the Fastly platform. We create multivariant libraries for `libsodium` and a `qrcode_generator`. Then, we pass the generated multivariant libraries to the `rustc` compiler during compiling to generate a valid executable Wasm binary (according to the Fastly ABI). We followed the walktthrough previously mentioned.

1 - Each project folder(`fastly/link_sodium` and `fastly/link_qrcode`) contains the corresponding scripting to collect the LLVM bitcodes to diversify and merge with MEWE:
- **link_qrcode**: In this case we intercept the intermediate bitcodes generated by rustc, and we then take them as the target for diversification. We collect them by running `python rust/build.py` in the `fastly/link_qrcode` folder.

- **link_sodium**: We take the bitcode generated from the compilation of the libsodium project as the target for diversification. The file could be found at `inlined/original/allinone.bc`.

2 - We generate semantically equivalent variants from the functions inside the collected bitcodes. We use CROW for such task, we pass the collected bitcodes to CROW, and we collect the generated variants.

3 - After collecting the variants we merge them with our linker into multivariant libraries. 

4 - The multivariant libraries can be then used by any LLVM-like compiler. 

5 - We use `rustc` to link the multivariant libraries to 7 endpoints to be deployed as functions in the Fastly's platform. 

We follow a similar approach in the [calling_crow](examples/calling_crow) example.

# License

This project is licensed under the MIT license. See [LICENSE](LICENSE.md) for more details.